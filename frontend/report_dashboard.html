<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Parkinson's Prediction Report</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Parkinson's Prediction</h1>
        <nav>
          <ul>
            <li><a href="chatbot.html">Chatbot</a></li>
            <li><a href="prediction.html">Prediction</a></li>
            <li><a href="report_dashboard.html" class="active">Report</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <div class="report-dashboard-container" id="report-content-to-pdf">
        <h2>Your Prediction Report</h2>

        <div id="report-summary" class="prediction-result report-result-box">
          <p>Loading prediction summary...</p>
        </div>

        <div class="dashboard-sections">
          <div class="dashboard-section chart-section">
            <h3>Vocal Feature Analysis</h3>
            <div class="chart-container-wrapper">
              <canvas id="vocalFeatureChart"></canvas>
            </div>
          </div>

          <div class="dashboard-section data-table-section">
            <h3>Detailed Feature Values & Ranges</h3>
            <table id="featureTable">
              <thead>
                <tr>
                  <th>Feature</th>
                  <th>Your Value</th>
                  <th>Typical Healthy Range</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="disclaimer-text">
          <h3>Important Disclaimer:</h3>
          <p>
            This prediction is for informational purposes only and should not be
            considered a substitute for professional medical advice, diagnosis,
            or treatment. Always consult with a qualified healthcare
            professional for any health concerns or before making any decisions
            related to your health or treatment.
          </p>
        </div>
      </div>
      <div class="report-actions">
        <a href="prediction.html" class="back-to-prediction-btn"
          >Make Another Prediction</a
        >
        <button id="download-pdf-btn" class="download-pdf-btn">
          Download Report as PDF
        </button>
      </div>

      <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Generating PDF...</p>
      </div>
    </main>

    <footer>
      <div class="container">
        <p>&copy; 2024 Parkinson's Chatbot. All rights reserved.</p>
      </div>
    </footer>

    <script>
      // Initialize jsPDF globally for easier access
      const { jsPDF } = window.jspdf;

      document.addEventListener("DOMContentLoaded", () => {
        const reportSummaryDiv = document.getElementById("report-summary");
        const featureTableBody = document.querySelector("#featureTable tbody");
        const vocalFeatureChartCanvas =
          document.getElementById("vocalFeatureChart");
        const downloadPdfBtn = document.getElementById("download-pdf-btn");
        const loadingOverlay = document.getElementById("loading-overlay");

        let myChart = null; // Chart.js instance

        const storedPredictionData = localStorage.getItem(
          "parkinsonsPrediction"
        );

        // Define typical healthy ranges and chart scales (min/max for each axis)
        // THESE RANGES ARE ADJUSTED FOR BETTER DISCRIMINATION OF "HEALTHY" VS "POTENTIAL DEVIATION"
        // They are approximate thresholds based on common understanding in voice analysis for PD.
        const featureConfigs = {
          "MDVP:Fo(Hz)": {
            min: 80,
            max: 200,
            label: "Avg Freq (Hz)",
            chartScaleMin: 80,
            chartScaleMax: 270,
          }, // Adjusted max for healthy, as per general adult male/female range
          "MDVP:Fhi(Hz)": {
            min: 100,
            max: 450,
            label: "Max Freq (Hz)",
            chartScaleMin: 90,
            chartScaleMax: 600,
          }, // Adjusted max
          "MDVP:Flo(Hz)": {
            min: 70,
            max: 170,
            label: "Min Freq (Hz)",
            chartScaleMin: 60,
            chartScaleMax: 250,
          }, // Adjusted max
          "MDVP:Jitter(%)": {
            min: 0.001,
            max: 0.003,
            label: "Jitter (%)",
            chartScaleMin: 0,
            chartScaleMax: 0.03,
          }, // Tighter max for healthy
          "MDVP:Jitter(Abs)": {
            min: 0.000005,
            max: 0.00004,
            label: "Jitter (Abs)",
            chartScaleMin: 0,
            chartScaleMax: 0.0003,
          }, // Fixed non-zero range, tighter max
          "MDVP:RAP": {
            min: 0.0005,
            max: 0.0015,
            label: "RAP",
            chartScaleMin: 0,
            chartScaleMax: 0.02,
          }, // Tighter max
          "MDVP:PPQ": {
            min: 0.001,
            max: 0.0018,
            label: "PPQ",
            chartScaleMin: 0,
            chartScaleMax: 0.03,
          }, // Tighter max
          "Jitter:DDP": {
            min: 0.002,
            max: 0.0045,
            label: "Jitter DDP",
            chartScaleMin: 0,
            chartScaleMax: 0.08,
          }, // Tighter max
          "MDVP:Shimmer": {
            min: 0.01,
            max: 0.025,
            label: "Shimmer",
            chartScaleMin: 0,
            chartScaleMax: 0.15,
          }, // Tighter max
          "MDVP:Shimmer(dB)": {
            min: 0.05,
            max: 0.25,
            label: "Shimmer (dB)",
            chartScaleMin: 0,
            chartScaleMax: 1.5,
          }, // Tighter max
          "Shimmer:APQ3": {
            min: 0.002,
            max: 0.012,
            label: "APQ3",
            chartScaleMin: 0,
            chartScaleMax: 0.08,
          }, // Tighter max
          "Shimmer:APQ5": {
            min: 0.003,
            max: 0.015,
            label: "APQ5",
            chartScaleMin: 0,
            chartScaleMax: 0.09,
          }, // Tighter max
          "MDVP:APQ": {
            min: 0.01,
            max: 0.02,
            label: "MDVP APQ",
            chartScaleMin: 0,
            chartScaleMax: 0.15,
          }, // Tighter max
          "Shimmer:DDA": {
            min: 0.006,
            max: 0.035,
            label: "Shimmer DDA",
            chartScaleMin: 0,
            chartScaleMax: 0.2,
          }, // Tighter max
          NHR: {
            min: 0.001,
            max: 0.015,
            label: "NHR",
            chartScaleMin: 0,
            chartScaleMax: 0.35,
          }, // Tighter max for healthy
          HNR: {
            min: 20,
            max: 35,
            label: "HNR (dB)",
            chartScaleMin: 8,
            chartScaleMax: 35,
          }, // Healthy HNR is high, min is threshold
          RPDE: {
            min: 0.35,
            max: 0.55,
            label: "RPDE",
            chartScaleMin: 0.2,
            chartScaleMax: 0.7,
          }, // Adjusted range
          DFA: {
            min: 0.65,
            max: 0.75,
            label: "DFA",
            chartScaleMin: 0.5,
            chartScaleMax: 0.9,
          }, // Adjusted range
          spread1: {
            min: -6,
            max: -4.5,
            label: "spread1",
            chartScaleMin: -8,
            chartScaleMax: -2,
          }, // Tighter range for healthy (less negative)
          spread2: {
            min: 0.15,
            max: 0.25,
            label: "spread2",
            chartScaleMin: 0,
            chartScaleMax: 0.5,
          }, // Tighter range
          D2: {
            min: 1.8,
            max: 2.8,
            label: "D2",
            chartScaleMin: 1.4,
            chartScaleMax: 4.0,
          }, // Tighter range
          PPE: {
            min: 0.05,
            max: 0.15,
            label: "PPE",
            chartScaleMin: 0.05,
            chartScaleMax: 0.55,
          }, // Tighter max for healthy
        };

        // Selected features for the Radar Chart (can be a subset of all features)
        const radarChartFeatures = [
          "MDVP:Fo(Hz)",
          "MDVP:Jitter(%)",
          "MDVP:Shimmer",
          "NHR",
          "HNR",
          "PPE",
          "spread1",
          "DFA",
        ];

        if (storedPredictionData) {
          const predictionData = JSON.parse(storedPredictionData);
          const percentage = (predictionData.probability * 100).toFixed(2);
          const inputFeatures = predictionData.inputFeatures;

          // --- Display Prediction Summary ---
          let summaryMessage = "";
          if (predictionData.prediction === 1) {
            summaryMessage = `<h3>High Likelihood of Parkinson's</h3>
                                      <p>Based on the provided voice features, there is a <strong>${percentage}% chance</strong> that the characteristics are consistent with Parkinson's disease.</p>`;
            reportSummaryDiv.classList.add("parkinsons-positive");
          } else {
            summaryMessage = `<h3>Low Likelihood of Parkinson's</h3>
                                      <p>Based on the provided voice features, there is a <strong>${percentage}% chance</strong> that the characteristics are consistent with Parkinson's disease.</p>`;
            reportSummaryDiv.classList.add("parkinsons-negative");
          }
          reportSummaryDiv.innerHTML = summaryMessage;
          reportSummaryDiv.classList.add("show");

          // --- Populate Detailed Feature Table (HTML) ---
          for (const featureName in inputFeatures) {
            if (inputFeatures.hasOwnProperty(featureName)) {
              const row = featureTableBody.insertRow();
              const cellFeature = row.insertCell();
              const cellValue = row.insertCell();
              const cellRange = row.insertCell();

              cellFeature.textContent = featureName;
              const valueToDisplay = [
                "HNR",
                "D2",
                "spread1",
                "spread2",
                "RPDE",
                "DFA",
              ].includes(featureName)
                ? inputFeatures[featureName].toFixed(3)
                : inputFeatures[featureName].toFixed(6);
              cellValue.textContent = valueToDisplay;

              const config = featureConfigs[featureName];
              if (config) {
                cellRange.textContent = `${config.min.toFixed(
                  3
                )} - ${config.max.toFixed(3)}`;
                // Highlight in HTML table based on improved health ranges
                let isValueHealthy = true; // Default to healthy

                // Custom logic for various features based on their healthy ranges
                if (featureName === "HNR") {
                  isValueHealthy = inputFeatures[featureName] >= config.min; // HNR: higher is healthier (value should be >= min)
                } else if (
                  [
                    "MDVP:Jitter(%)",
                    "MDVP:Jitter(Abs)",
                    "MDVP:RAP",
                    "MDVP:PPQ",
                    "Jitter:DDP",
                    "MDVP:Shimmer",
                    "MDVP:Shimmer(dB)",
                    "Shimmer:APQ3",
                    "Shimmer:APQ5",
                    "MDVP:APQ",
                    "Shimmer:DDA",
                    "NHR",
                    "PPE",
                  ].includes(featureName)
                ) {
                  isValueHealthy = inputFeatures[featureName] <= config.max; // Jitter, Shimmer, NHR, PPE: lower is healthier (value should be <= max)
                } else if (featureName === "spread1") {
                  isValueHealthy =
                    inputFeatures[featureName] >= config.min &&
                    inputFeatures[featureName] <= config.max; // spread1: specific range for healthy (less negative)
                } else {
                  // For other features, standard range check (between min and max)
                  isValueHealthy =
                    inputFeatures[featureName] >= config.min &&
                    inputFeatures[featureName] <= config.max;
                }

                if (isValueHealthy) {
                  cellValue.classList.add("value-in-range");
                } else {
                  cellValue.classList.add("value-out-of-range");
                }
              } else {
                cellRange.textContent = "N/A";
              }
            }
          }

          // --- Generate Radar Chart with Per-Axis Scales ---
          // Data for the 'Your Values' dataset
          const patientValues = radarChartFeatures.map((f) => inputFeatures[f]);
          // Data for the 'Healthy Min' dataset (lower bound of the healthy range)
          const healthyMinValues = radarChartFeatures.map(
            (f) => featureConfigs[f].min
          );
          // Data for the 'Healthy Max' dataset (upper bound of the healthy range)
          const healthyMaxValues = radarChartFeatures.map(
            (f) => featureConfigs[f].max
          );

          const datasets = [
            {
              label: "Your Values",
              data: patientValues,
              backgroundColor: "rgba(52, 152, 219, 0.6)", // Blue, slightly more opaque
              borderColor: "rgba(52, 152, 219, 1)",
              borderWidth: 2,
              fill: false, // Don't fill under this line
              pointBackgroundColor: "rgba(52, 152, 219, 1)",
              pointBorderColor: "#fff",
              pointHoverBackgroundColor: "#fff",
              pointHoverBorderColor: "rgba(52, 152, 219, 1)",
            },
            {
              label: "Healthy Min",
              data: healthyMinValues,
              backgroundColor: "rgba(76, 175, 80, 0.2)", // Light green fill for range
              borderColor: "rgba(76, 175, 80, 0.5)", // Light green line
              borderWidth: 1,
              borderDash: [5, 5], // Dashed line
              pointRadius: 0, // No points for range
              fill: "+1", // Fill to the next dataset (Healthy Max)
            },
            {
              label: "Healthy Max",
              data: healthyMaxValues,
              backgroundColor: "rgba(76, 175, 80, 0)", // Transparent fill, as it's filled by Healthy Min
              borderColor: "rgba(76, 175, 80, 0.5)", // Light green line
              borderWidth: 1,
              borderDash: [5, 5], // Dashed line
              pointRadius: 0, // No points for range
              fill: false, // No fill
            },
          ];

          // Calculate min/max for the overall radar scale based on all radar features' min/max from featureConfigs
          // This ensures the chart covers the necessary range including healthy boundaries.
          const allMinValues = radarChartFeatures.map(
            (f) => featureConfigs[f].chartScaleMin
          );
          const allMaxValues = radarChartFeatures.map(
            (f) => featureConfigs[f].chartScaleMax
          );
          const combinedValues = [
            ...patientValues,
            ...allMinValues,
            ...allMaxValues,
          ];

          const minOverallRadar = Math.min(...combinedValues);
          const maxOverallRadar = Math.max(...combinedValues);

          const scales = {
            r: {
              angleLines: { display: true },
              ticks: { beginAtZero: false }, // Allows negative values
              grid: { circular: true },
              pointLabels: {
                display: true,
                font: { size: 12 },
                color: "#333",
              },
              min: minOverallRadar,
              max: maxOverallRadar,
              ticks: {
                callback: function (value) {
                  if (value === 0) return "0";
                  // More granular tick formatting based on common ranges
                  if (value > 100) return value.toFixed(0); // Frequencies
                  if (value > 10) return value.toFixed(1); // HNR
                  if (value > 1) return value.toFixed(2); // D2, DFA, RPDE
                  if (value > 0.1) return value.toFixed(3); // Shimmer, spread2
                  if (value >= 0.001) return value.toFixed(4); // Jitter, NHR, PPE, APQ
                  if (value < 0 && value > -1) return value.toFixed(2); // Negative small decimals
                  return value.toFixed(0); // General case
                },
              },
            },
          };

          const ctx = vocalFeatureChartCanvas.getContext("2d");
          if (myChart) {
            myChart.destroy();
          }
          myChart = new Chart(ctx, {
            type: "radar",
            data: {
              labels: radarChartFeatures.map((f) =>
                featureConfigs[f] ? featureConfigs[f].label : f
              ),
              datasets: datasets,
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: scales,
              plugins: {
                title: { display: false },
                tooltip: {
                  callbacks: {
                    label: function (context) {
                      let label = context.dataset.label || "";
                      if (label) {
                        label += ": ";
                      }
                      const featureName = radarChartFeatures[context.dataIndex];
                      const value = context.raw;

                      // Apply specific formatting for tooltip values
                      if (
                        featureName.includes("Jitter") ||
                        featureName.includes("Shimmer") ||
                        featureName.includes("NHR") ||
                        featureName.includes("PPE")
                      ) {
                        label += value.toFixed(5); // Higher precision for tooltip
                      } else if (featureName.includes("spread1")) {
                        label += value.toFixed(3);
                      } else {
                        label += value.toFixed(3);
                      }

                      // Add healthy range to tooltip if applicable
                      const config = featureConfigs[featureName];
                      if (config) {
                        label += ` (Range: ${config.min.toFixed(
                          3
                        )} - ${config.max.toFixed(3)})`;
                      }
                      return label;
                    },
                  },
                },
                legend: {
                  display: true,
                  position: "top",
                },
                datalabels: {
                  display: false, // Hide datalabels for clarity with multiple datasets
                  // If you want to show only patient values, you can set display: true and customize.
                  // display: function(context) {
                  //     return context.datasetIndex === 0; // Only show for 'Your Values' dataset
                  // },
                  color: "#333",
                  font: { weight: "bold", size: 10 },
                  formatter: function (value, context) {
                    const featureName = radarChartFeatures[context.dataIndex];
                    if (
                      featureName.includes("Jitter") ||
                      featureName.includes("Shimmer") ||
                      featureName.includes("NHR") ||
                      featureName.includes("PPE")
                    ) {
                      return value.toFixed(4);
                    } else if (featureName.includes("spread1")) {
                      return value.toFixed(2);
                    } else {
                      return value.toFixed(2);
                    }
                  },
                },
              },
            },
            plugins: [ChartDataLabels],
          });

          localStorage.removeItem("parkinsonsPrediction"); // Clean up storage after display

          // --- PDF Download Event Listener ---
          downloadPdfBtn.addEventListener("click", async () => {
            loadingOverlay.style.display = "flex"; // Show loading spinner

            try {
              // Give chart a moment to fully render/settle, especially for PDF capture
              await new Promise((resolve) => setTimeout(resolve, 750)); // Increased delay for chart to render fully

              // Get Chart as Image
              const chartImage = await html2canvas(vocalFeatureChartCanvas, {
                scale: 2, // Higher scale for better quality
                useCORS: true,
                allowTaint: true,
                backgroundColor: "#fff", // Ensure chart background is white
              }).then((canvas) => canvas.toDataURL("image/png"));

              // Initialize jsPDF
              const doc = new jsPDF();
              let yPos = 10; // Initial Y position for content

              // Add Title
              doc.setFontSize(20);
              doc.text("Parkinson's Prediction Report", 105, yPos, {
                align: "center",
              });
              yPos += 20;

              // Add Prediction Summary
              doc.setFontSize(14);
              const summaryText = reportSummaryDiv.textContent;
              // Use splitTextToSize for multiline text if content is long
              const splitSummary = doc.splitTextToSize(summaryText, 180); // Max width 180mm
              doc.text(splitSummary, 105, yPos, { align: "center" });
              yPos += splitSummary.length * 6 + 10; // Adjust line height for PDF text

              // Add Chart Image
              const imgWidth = 180; // Image width in mm (approx A4 width is 210mm)
              const imgHeight =
                (vocalFeatureChartCanvas.height * imgWidth) /
                vocalFeatureChartCanvas.width; // Maintain aspect ratio
              doc.addImage(chartImage, "PNG", 15, yPos, imgWidth, imgHeight);
              yPos += imgHeight + 10;

              // Add Detailed Feature Values Table
              doc.setFontSize(16);
              doc.text("Detailed Feature Values & Ranges", 10, yPos);
              yPos += 10;

              const tableHeaders = [
                ["Feature", "Your Value", "Typical Healthy Range"],
              ];
              const tableData = [];

              // Collect data for jsPDF table, applying colors
              for (const featureName in inputFeatures) {
                if (inputFeatures.hasOwnProperty(featureName)) {
                  const value = inputFeatures[featureName];
                  const config = featureConfigs[featureName];

                  const valueToDisplay = [
                    "HNR",
                    "D2",
                    "spread1",
                    "spread2",
                    "RPDE",
                    "DFA",
                  ].includes(featureName)
                    ? value.toFixed(3)
                    : value.toFixed(6);
                  const rangeText = config
                    ? `${config.min.toFixed(3)} - ${config.max.toFixed(3)}`
                    : "N/A";

                  const row = [featureName, valueToDisplay, rangeText];
                  tableData.push(row);
                }
              }

              // Use autoTable plugin for jsPDF
              doc.autoTable({
                startY: yPos,
                head: tableHeaders,
                body: tableData,
                theme: "grid",
                headStyles: { fillColor: [44, 62, 80] }, // Dark blue header
                styles: {
                  font: "helvetica",
                  fontSize: 10,
                  cellPadding: 3,
                  valign: "middle",
                  halign: "left",
                },
                columnStyles: {
                  0: { cellWidth: 50 }, // Feature Name
                  1: { cellWidth: 40, halign: "center" }, // Your Value
                  2: { cellWidth: 60, halign: "center" }, // Typical Range
                },
                didParseCell: function (data) {
                  // Apply highlighting for 'Your Value' column in PDF table
                  if (data.column.index === 1 && data.section === "body") {
                    const featureName = data.row.raw[0]; // Get feature name from first column
                    const value = parseFloat(data.cell.text[0]); // Get the value
                    const config = featureConfigs[featureName];

                    if (config) {
                      let isValueHealthy = true; // Default to healthy

                      // Custom logic for various features based on their healthy ranges
                      if (featureName === "HNR") {
                        isValueHealthy = value >= config.min; // HNR: higher is healthier
                      } else if (
                        [
                          "MDVP:Jitter(%)",
                          "MDVP:Jitter(Abs)",
                          "MDVP:RAP",
                          "MDVP:PPQ",
                          "Jitter:DDP",
                          "MDVP:Shimmer",
                          "MDVP:Shimmer(dB)",
                          "Shimmer:APQ3",
                          "Shimmer:APQ5",
                          "MDVP:APQ",
                          "Shimmer:DDA",
                          "NHR",
                          "PPE",
                        ].includes(featureName)
                      ) {
                        isValueHealthy = value <= config.max; // Jitter, Shimmer, NHR, PPE: lower is healthier
                      } else if (featureName === "spread1") {
                        isValueHealthy =
                          value >= config.min && value <= config.max; // spread1: specific range for healthy
                      } else {
                        isValueHealthy =
                          value >= config.min && value <= config.max; // For others, standard range
                      }

                      if (isValueHealthy) {
                        data.cell.styles.fillColor = [232, 245, 233]; // Light green RGB
                        data.cell.styles.textColor = [46, 125, 50]; // Dark green RGB
                      } else {
                        data.cell.styles.fillColor = [255, 243, 224]; // Light orange RGB
                        data.cell.styles.textColor = [230, 81, 0]; // Dark orange RGB
                      }
                    }
                  }
                },
                margin: { left: 10, right: 10 },
              });
              yPos = doc.autoTable.previous.finalY + 10; // Update yPos after table

              // Add Disclaimer
              doc.setFontSize(10);
              doc.setTextColor(102, 102, 102); // Gray color RGB
              const disclaimerTitle = "Important Disclaimer:";
              const disclaimerText =
                "This prediction is for informational purposes only and should not be considered a substitute for professional medical advice, diagnosis, or treatment. Always consult with a qualified healthcare professional for any health concerns or before making any decisions related to your health or treatment.";

              doc.text(disclaimerTitle, 10, yPos);
              yPos += 5;
              const splitDisclaimer = doc.splitTextToSize(disclaimerText, 190);
              doc.text(splitDisclaimer, 10, yPos);

              doc.save(
                `parkinsons_report_${new Date().toISOString().slice(0, 10)}.pdf`
              );
            } catch (error) {
              console.error("Error generating PDF:", error);
              alert("Failed to generate PDF. Check console for details.");
            } finally {
              loadingOverlay.style.display = "none"; // Hide loading spinner
            }
          });
        } else {
          reportSummaryDiv.innerHTML = `<p class="error-message show">No prediction data found. Please go back and make a prediction.</p>`;
          reportSummaryDiv.classList.add("show");
        }
      });
    </script>
  </body>
</html>
